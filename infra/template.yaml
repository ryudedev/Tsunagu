AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  TsunaguApp

# パラメータを追加してURLを柔軟に設定
Parameters:
  AppURL:
    Type: String
    Default: "http://localhost:3000"
    Description: "The URL of the frontend application"

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 10
    Handler: app.lambda_handler
    Runtime: python3.13
    LoggingConfig:
      LogFormat: JSON
    # 共通の環境変数をここに定義
    Environment:
      Variables:
        POSTS_TABLE_NAME: !Ref PostsTable
        USER_POOL_ID: !Ref TsunaguUserPool

Resources:
  # Cognito
  # 論理ID: TsunaguUserPool
  # サービス: Cognito
  # 説明: Cognito User Pool
  TsunaguUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: TsunaguUserPool
      UsernameAttributes:
        - email
      # ユーザープールの詳細設定を追加
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: false
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false
      # アカウント回復設定
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
  
  # 論理ID: TsunaguUserPoolDomain
  # サービス: Cognito
  # 説明: Cognitoのドメイン設定
  TsunaguUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub "tsunagu-app-${AWS::AccountId}"
      UserPoolId: !Ref TsunaguUserPool
  
  # 論理ID: TsunaguGoogleIdP
  # サービス: Cognito
  # 説明: Cognitoのプロバイダー設定
  TsunaguGoogleIdP:
    Type: AWS::Cognito::UserPoolIdentityProvider
    Properties:
      ProviderName: Google
      ProviderType: Google
      UserPoolId: !Ref TsunaguUserPool
      ProviderDetails:
        client_id: "{{resolve:secretsmanager:TsunaguGoogleSecrets:SecretString:google-client-id}}"
        client_secret: "{{resolve:secretsmanager:TsunaguGoogleSecrets:SecretString:google-client-secret}}"
        authorize_scopes: "profile email openid"
      AttributeMapping:
        email: "email"
        username: "sub"
        name: "name"

  # 論理ID: TsunaguUserPoolClient
  # サービス: Cognito
  # 説明: Cognito User Pool Client
  TsunaguUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    DependsOn: TsunaguGoogleIdP
    Properties:
      UserPoolId: !Ref TsunaguUserPool
      ClientName: TsunaguWebClient
      GenerateSecret: false
      SupportedIdentityProviders:
        - COGNITO
        - Google
      CallbackURLs:
        - !Sub "${AppURL}/"
        - "http://localhost:3000/"  # 開発環境用
        # - !Sub "${AppURL}/login"
        # - http://localhost:3000/login
      LogoutURLs:
        - !Sub "${AppURL}/login"
        - "http://localhost:3000/login"  # 開発環境用
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
        - aws.cognito.signin.user.admin
      AllowedOAuthFlowsUserPoolClient: true
      # トークンの有効期限設定
      RefreshTokenValidity: 30
      AccessTokenValidity: 60
      IdTokenValidity: 60
      TokenValidityUnits:
        RefreshToken: days
        AccessToken: minutes
        IdToken: minutes
      # その他の重要な設定
      PreventUserExistenceErrors: ENABLED
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH

  # DynamoDB
  # 論理ID: PostsTable
  # サービス: Cognito
  # 説明: 投稿情報格納用データベース
  PostsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Posts
      BillingMode: 'PAY_PER_REQUEST'
      AttributeDefinitions:
        - AttributeName: postId
          AttributeType: S
      KeySchema:
        - AttributeName: postId
          KeyType: HASH
  
  # API Gateway
  # 論理ID: TsunaguApiGateway
  # サービス: API Gateway
  # 説明: 
  TsunaguApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Dev
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization'"
        AllowOrigin: "'*'"
      Auth:
        DefaultAuthorizer: TsunaguApiAuthorizer
        Authorizers:
          TsunaguApiAuthorizer:
            FunctionArn: !GetAtt ApiAuthorizerFunction.Arn
            Identity:
              Headers:
                - Authorization

  # Lambda
  # 論理ID: ApiAuthorizerFunction
  # Service: Lambda
  # 説明: 認証用関数
  ApiAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/authorizer/

  # 論理ID: HelloWorldFunction
  # サービス: Lambda
  # 説明: 疎通確認用関数
  HelloWorldFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/hello_world/
      Architectures:
        - x86_64
      Events:
        HelloWorld:
          Type: Api
          Properties:
            RestApiId: !Ref TsunaguApiGateway
            Path: /ping
            Method: get
            Auth:
              Authorizer: NONE

  # 論理ID: GetPostsFunction
  # サービス: Lambda
  # 説明: 投稿一覧取得用関数
  GetPostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/getPosts/
      Architectures:
        - x86_64
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref PostsTable
      Events:
        GetPosts:
          Type: Api
          Properties:
            RestApiId: !Ref TsunaguApiGateway
            Path: /posts
            Method: get

  # 論理ID: CreatePostsFunction
  # サービス: Lambda
  # 説明: 投稿作成用関数
  CreatePostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/createPosts/
      Architectures:
        - x86_64
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PostsTable
      Events:
        CreatePosts:
          Type: Api
          Properties:
            RestApiId: !Ref TsunaguApiGateway
            Path: /posts
            Method: post
            # Authの記述がないため、デフォルトのTsunaguApiAuthorizerが適用される

Outputs:
  TsunaguApiEndpoint:
    Description: "API Gateway endpoint URL for Dev stage"
    Value: !Sub "https://${TsunaguApiGateway}.execute-api.${AWS::Region}.amazonaws.com/Dev"
  
  TsunaguUserPoolId:
    Description: "Cognito User Pool ID"
    Value: !Ref TsunaguUserPool

  TsunaguUserPoolClientId:
    Description: "Cognito User Pool Client ID"
    Value: !Ref TsunaguUserPoolClient

  TsunaguUserPoolDomain:
    Description: "Cognito User Pool Domain"
    Value: !Sub "https://tsunagu-app-${AWS::AccountId}.auth.${AWS::Region}.amazoncognito.com"

  # フロントエンド用の環境変数設定例
  EnvironmentVariables:
    Description: "Environment variables for frontend application"
    Value: !Sub |
      NEXT_PUBLIC_COGNITO_USER_POOL_ID=${TsunaguUserPool}
      NEXT_PUBLIC_COGNITO_USER_POOL_CLIENT_ID=${TsunaguUserPoolClient}
      NEXT_PUBLIC_COGNITO_DOMAIN=tsunagu-app-${AWS::AccountId}.auth.${AWS::Region}.amazoncognito.com
      NEXT_PUBLIC_APP_URL=${AppURL}